#!/usr/bin/env node
const fs = require('fs');
const path = require('path');

const repoRoot = path.resolve(__dirname, '..');
const mdPath = path.join(repoRoot, 'DEFAULT_ROLE_PROMPTS.md');
const outPath = path.join(repoRoot, 'src', 'defaultPrompts.ts');

function readMd() {
  if (!fs.existsSync(mdPath)) {
    console.error('DEFAULT_ROLE_PROMPTS.md not found');
    process.exit(1);
  }
  return fs.readFileSync(mdPath, 'utf8');
}

function extractSystem(md) {
  // Try English or Chinese header variants
  const re = /##\s*System[^\n]*\n([\s\S]*?)(?:\n##\s|$)/i;
  const reCn = /##\s*System（系统）[\s\S]*?\n([\s\S]*?)(?:\n##\s|$)/i;
  let m = md.match(reCn) || md.match(re);
  if (m && m[1]) return m[1].trim();
  // Fallback: take first 300 chars of the file
  return md.slice(0, 300).trim();
}

function escapeBackticks(s) {
  return s.replace(/`/g, '\\`');
}

function generateTs(systemContent, fullMd) {
  const escSystem = escapeBackticks(systemContent);
  const escMd = escapeBackticks(fullMd);
  return `// This file is generated by scripts/sync-default-prompts.js
// Do not hand-edit if you plan to run the sync script again.

export const SYSTEM_PROMPT = ` + '`' + `${escSystem}` + '`' + `;

export const DEFAULT_PROMPTS_README = "DEFAULT_ROLE_PROMPTS.md";

export const DEFAULT_PROMPTS_MD = ` + '`' + `${escMd}` + '`' + `;
`;
}

function writeOut(tsContent) {
  fs.mkdirSync(path.dirname(outPath), { recursive: true });
  fs.writeFileSync(outPath, tsContent, 'utf8');
}

function main() {
  const md = readMd();
  const system = extractSystem(md);
  const ts = generateTs(system, md);
  writeOut(ts);
  console.log('Wrote', outPath);
}

main();
